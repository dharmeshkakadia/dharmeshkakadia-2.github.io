<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">

  <!-- mobile responsive meta -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Automate SQL server data pipelines with Kubernetes</title>
  <meta name='description' content='Curious'>

  <link rel="canonical" href="/sql-k8s-jobs/">
  <link rel="alternate" type="application/rss+xml" title="Dharmesh Kakadia" href="/feed.xml">

  <!-- Main Stylesheet -->
  <link href="/assets/css/main.css" rel="stylesheet">

</head>


<body>

  
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-44808193-2', 'auto');
  ga('send', 'pageview');
</script>
  

  <div class="container-full">
  <!-- begin header -->
  <header class="header">

    <div class="logo">
      <a class="logo__link" href="/">
      
        <img class="logo__image" src=" /images/dharmesh.png" alt="Dharmesh Kakadia">
        Dharmesh Kakadia
      
      </a>
    </div>

    <nav class="main-nav">
      <span class="main-nav__open">menu</span>

      <div class="main-nav__box">
        <span class="main-nav__close">Close</span>

        <ul class="nav__list list-reset">
          <li class="nav__item">
            <a href="/" class="nav__link">Home</a>
          </li>

          <li class="nav__item">
            <a href="/about" class="nav__link">About</a>
          </li>

          <li class="nav__item">
            <a href="/words/" class="nav__link">Quotes</a>
          </li>

          <li class="nav__item">
            <a href="/book/" class="nav__link">My Book</a>
          </li>


          <li class="nav__item">
            <a href="/talks" class="nav__link">Talks</a>
          </li>
          
        </ul>

      </div>

    </nav>

  </header>
  <!-- end header -->
</div>


  <!-- begin content -->
  <main class="content" aria-label="Content">
    <div class="container">
  <!-- begin post -->
  <article class="post">
    <div class="post__head" data-aos="fade-up" data-aos-easing="ease-out-quad" data-aos-duration="700">
      <h1 class="post__title">Automate SQL server data pipelines with Kubernetes</h1>
      <div class="post__date">
        <time datetime="2018-03-09T00:00:00+00:00">Published Mar 09, 2018</time>
      </div>
      
    </div>

    <div class="post__content" data-aos="fade-up" data-aos-easing="ease-out-quad" data-aos-delay="100" data-aos-duration="700">
      <p>Kubernetes provides a great way to run modern infrastructure. SQL server is a widely deployed database. When you combine these two, you get a robust way of running a data pipeline using a modern platform.</p>

<p>Data pipelines are large part of all data infrastructure. The need to move data between different systems, is almost universal and tools/process to achieve this is generally referred to as a data pipeline. In this post we will see how we can leverage <a href="https://kubernetes.io/docs/concepts/workloads/controllers/jobs-run-to-completion/">Kubernetes jobs API</a> to build and run data pipelines. This is a great way to integrate data pipelines into CI/CD practices too.</p>

<p>Following steps will create an example SQL pipeline and run it against SQL server using Kubernetes. We will be running a very simple query to list all the tables.</p>

<ol>
  <li>
    <p>Lets define our job in the file <code class="highlighter-rouge">sql-k8s-job.yaml</code>.</p>

    <div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">batch/v1</span>
 <span class="na">kind</span><span class="pi">:</span> <span class="s">Job</span>
 <span class="na">metadata</span><span class="pi">:</span>
 <span class="na">name</span><span class="pi">:</span> <span class="s">sqljob</span>
 <span class="na">spec</span><span class="pi">:</span>
 <span class="na">template</span><span class="pi">:</span>
     <span class="na">spec</span><span class="pi">:</span>
     <span class="na">containers</span><span class="pi">:</span>
     <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">sqljobcontainer</span>
         <span class="s">image</span><span class="pi">:</span> <span class="s">microsoft/mssql-tools</span>
         <span class="s">command</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">/opt/mssql-tools/bin/sqlcmd"</span><span class="pi">]</span>
         <span class="na">args</span><span class="pi">:</span> <span class="pi">[</span> <span class="s2">"</span><span class="s">-S"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">mysqlserver.database.windows.net"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">-d"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">mydatabase"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">-U"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">User"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">-P"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">PassWord"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">-I"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">-Q"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">SELECT</span><span class="nv"> </span><span class="s">name</span><span class="nv"> </span><span class="s">FROM</span><span class="nv"> </span><span class="s">sys.tables"</span> <span class="pi">]</span>
     <span class="na">restartPolicy</span><span class="pi">:</span> <span class="s">Never</span>
</code></pre></div>    </div>

    <p>Here, we are specifying that this is a job definition(<code class="highlighter-rouge">kind: Job</code>) with the name <code class="highlighter-rouge">sqljob</code>. The spec part is similar to other container specifications. We are specifying it to create a container with a name <code class="highlighter-rouge">sqljobcontainer</code> with the image <code class="highlighter-rouge">microsoft/mssql-tools</code>. This image has all MSSQL tools installed to connect to a remote MSSQL instance. We are also specifying that it should run <code class="highlighter-rouge">sqlcmd</code> command with the specified arguments, including server, database, password and query when it starts the container. Note that, I am specifying password in the job definition file here just for simplicity, you should use <a href="https://kubernetes.io/docs/concepts/configuration/secret/">kubernetes secrets</a> when doing anything serious.</p>
  </li>
  <li>
    <p>Lets run it. You can run it locally using <a href="https://kubernetes.io/docs/getting-started-guides/minikube/">minikube</a> or on cloud.</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> kubectl create -f sql-k8s-job.yaml
    
 job "sqljob" created
</code></pre></div>    </div>
  </li>
  <li>You can see the details on the job.
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> kubectl describe jobs/sqljob

 Name:           sqljob
 Namespace:      default
 Selector:       controller-uid=85530e4e-2eef-11e8-9e3f-92f68014defe
 Labels:         controller-uid=85530e4e-2eef-11e8-9e3f-92f68014defe
                 job-name=sqljob
 Annotations:    &lt;none&gt;
 Parallelism:    1
 Completions:    1
 Start Time:     Fri, 23 Mar 2018 16:11:30 -0700
 Pods Statuses:  1 Running / 0 Succeeded / 2 Failed
 Pod Template:
 Labels:  controller-uid=85530e4e-2eef-11e8-9e3f-92f68014defe
         job-name=sqljob
 Containers:
 sqljobcontainer:
     Image:  microsoft/mssql-tools
     Port:   &lt;none&gt;
     Command:
     /opt/mssql-tools/bin/sqlcmd
     Args:
     -S
     mysqlserver.database.windows.net
     -d
     mydatabase
     -U
     User
     -P
     PassWord
     -I
     -Q
     SELECT name FROM sys.tables
     Environment:  &lt;none&gt;
     Mounts:       &lt;none&gt;
 Volumes:        &lt;none&gt;
 Events:
 Type    Reason            Age   From            Message
 ----    ------            ----  ----            -------
 Normal  SuccessfulCreate  30s   job-controller  Created pod: sqljob-qsdtg
 Normal  SuccessfulCreate  20s   job-controller  Created pod: sqljob-pws2m
 Normal  SuccessfulCreate  10s   job-controller  Created pod: sqljob-lb2dz
</code></pre></div>    </div>
    <p>You can also see the job on the kubernetes dashboard. You can open the kubernetes dashboard using</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> minikube dashboard
</code></pre></div>    </div>
    <p>You can see the job under jobs section in the dashboard.</p>

    <p><img src="/images/sql-k8s-job.png" alt="sqljib-k8s-dashboard" /></p>
  </li>
  <li>
    <p>Lets see the output from the job.</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> kubectl logs jobs/sqljob
</code></pre></div>    </div>
    <p>You should see the list of all the tables in your database.</p>
  </li>
  <li>
    <p>Finally you can delete the job using</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> kubectl delete jobs/sqljob

 job "sqljob" deleted
</code></pre></div>    </div>

    <p>Now that you have are comfortable with this job, you can easily convert this into a recurring job. Kubernetes jobs support for <a href="https://kubernetes.io/docs/concepts/workloads/controllers/cron-jobs/">cron jobs</a>. You can include the cron syntax schedule in the container spec to convert a job into a cron job. For example, by including <code class="highlighter-rouge">schedule: "0 * * * *"</code> in the <code class="highlighter-rouge">spec</code> section of the job, your job will run every 1-hour. Crontab syntax is hard to remember and undertstand, but luckily you can just use <a href="https://crontab.guru/">crontab.guru</a>.</p>
  </li>
</ol>

<p>Thats it. Go build your pipeline !</p>

    </div>

    

    <div class="post__share">
      <ul class="share__list list-reset">
        

        <li class="share__item">
          <a class="share__link share__twitter" href="https://twitter.com/intent/tweet?text=Automate%20SQL%20server%20data%20pipelines%20with%20Kubernetes&url=/sql-k8s-jobs/"
            onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter" rel="nofollow">
              <svg enable-background="new 0 0 56.693 56.693" height="56.693" viewBox="0 0 56.693 56.693" width="56.693" xmlns="http://www.w3.org/2000/svg"><path d="m52.837 15.065c-1.811.805-3.76 1.348-5.805 1.591 2.088-1.25 3.689-3.23 4.444-5.592-1.953 1.159-4.115 2-6.418 2.454-1.843-1.964-4.47-3.192-7.377-3.192-5.581 0-10.106 4.525-10.106 10.107 0 .791.089 1.562.262 2.303-8.4-.422-15.848-4.445-20.833-10.56-.87 1.492-1.368 3.228-1.368 5.082 0 3.506 1.784 6.6 4.496 8.412-1.656-.053-3.215-.508-4.578-1.265-.001.042-.001.085-.001.128 0 4.896 3.484 8.98 8.108 9.91-.848.23-1.741.354-2.663.354-.652 0-1.285-.063-1.902-.182 1.287 4.015 5.019 6.938 9.441 7.019-3.459 2.711-7.816 4.327-12.552 4.327-.815 0-1.62-.048-2.411-.142 4.474 2.869 9.786 4.541 15.493 4.541 18.591 0 28.756-15.4 28.756-28.756 0-.438-.009-.875-.028-1.309 1.974-1.422 3.688-3.203 5.042-5.23z"/></svg>
            </a>
        </li>

      </ul>
    </div>

    <div class="post__navigation">
      
      <a class="prev" href="/presto-event-listener/">
        <div class="prev__post-icon">
          <svg enable-background="new 0 0 512 512" height="512" viewBox="0 0 512 512" width="512" xmlns="http://www.w3.org/2000/svg"><path d="m352 128.4-32.3-32.4-159.7 160 159.7 160 32.3-32.4-127.3-127.6z"/></svg>
        </div>
        <span class="post__nav-wrapper">
          <div class="post__nav-image" style="background-image: url()"></div>
          <h2 class="post__nav-title"><time datetime="2018-03-09T00:00:00+00:00">Mar 09, 2018</time> <br>Write a Presto query logging plugin</h2>
        </span>
      </a>
      

      
      <a class="next" href="/ideas-hard/">
        <div class="next__post-icon">
          <svg enable-background="new 0 0 512 512" height="512" viewBox="0 0 512 512" width="512" xmlns="http://www.w3.org/2000/svg"><path d="m160 128.4 32.3-32.4 159.7 160-159.7 160-32.3-32.4 127.3-127.6z"/></svg>
        </div>
        <span class="post__nav-wrapper">
          <div class="post__nav-image" style="background-image: url()"></div>
          <h2 class="post__nav-title"><time datetime="2018-03-09T00:00:00+00:00">Mar 09, 2018</time> <br>Review - Are Ideas Getting Harder to Find?</h2>
        </span>
      </a>
      
    </div>

    

  </article>
  <!-- end post -->
</div>

  </main>
  <!-- end content -->

  <div class="container">
  <!-- begin footer -->
  <footer class="footer">
    <div class="footer__inner">
      <div class="contact">
        <div class="contact__title">Have a question where I can help? <a href="mailto:dharmesh.kakadia@gmail.com">Email me</a></div>
        <ul class="contact__list list-reset">
          
          <li class="contact__item">
            <a class="contact__link" href="https://twitter.com/dharmeshkakadia">Twitter</a>
          </li>
          
          <li class="contact__item">
            <a class="contact__link" href="https://facebook.com/dharmesh.kakadia">Facebook</a>
          </li>
          
          <li class="contact__item">
            <a class="contact__link" href="https://github.com/dharmeshkakadia">Github</a>
          </li>
          
          <li class="contact__item">
            <a class="contact__link" href="https://instagram.com/dharmeshkakadia">LinkedIn</a>
          </li>
          
        </ul>
      </div>
    </div>
  </footer>
  <!-- end footer -->
</div>


  <!-- begin js -->
  <script src="/assets/js/vendors/jquery-3.3.1.min.js"></script>
  <script src="/assets/js/vendors/aos.js"></script>
  <script src="/assets/js/vendors/jquery.fitvids.js"></script>
  <script src="/assets/js/common.js"></script>
  <!-- end js -->
</body>

</html>
