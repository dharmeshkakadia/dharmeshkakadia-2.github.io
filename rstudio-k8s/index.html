<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">

  <!-- mobile responsive meta -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Versatile RStudio development environment on Kubernetes</title>
  <meta name='description' content='Curious'>

  <link rel="canonical" href="/rstudio-k8s/">
  <link rel="alternate" type="application/rss+xml" title="Dharmesh Kakadia" href="/feed.xml">

  <!-- Main Stylesheet -->
  <link href="/assets/css/main.css" rel="stylesheet">

</head>


<body>

  
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-44808193-2', 'auto');
  ga('send', 'pageview');
</script>
  

  <div class="container-full">
  <!-- begin header -->
  <header class="header">

    <div class="logo">
      <a class="logo__link" href="/">
      
        <img class="logo__image" src=" /images/dharmesh.png" alt="Dharmesh Kakadia">
        Dharmesh Kakadia
      
      </a>
    </div>

    <nav class="main-nav">
      <span class="main-nav__open">menu</span>

      <div class="main-nav__box">
        <span class="main-nav__close">Close</span>

        <ul class="nav__list list-reset">
          <li class="nav__item">
            <a href="/" class="nav__link">Home</a>
          </li>

          <li class="nav__item">
            <a href="/about" class="nav__link">About</a>
          </li>

          <li class="nav__item">
            <a href="/words/" class="nav__link">Quotes</a>
          </li>

          <li class="nav__item">
            <a href="/book/" class="nav__link">My Book</a>
          </li>


          <li class="nav__item">
            <a href="/talks" class="nav__link">Talks</a>
          </li>
          
        </ul>

      </div>

    </nav>

  </header>
  <!-- end header -->
</div>


  <!-- begin content -->
  <main class="content" aria-label="Content">
    <div class="container">
  <!-- begin post -->
  <article class="post">
    <div class="post__head" data-aos="fade-up" data-aos-easing="ease-out-quad" data-aos-duration="700">
      <h1 class="post__title">Versatile RStudio development environment on Kubernetes</h1>
      <div class="post__date">
        <time datetime="2018-12-05T00:00:00+00:00">Published Dec 05, 2018</time>
      </div>
      
    </div>

    <div class="post__content" data-aos="fade-up" data-aos-easing="ease-out-quad" data-aos-delay="100" data-aos-duration="700">
      <p>R is very versatile language for data analysis and widely used for data science and exploration alongside python. <a href="https://www.rstudio.com/">RStudio</a> is a great IDE for exploring data using R. RStudio has a lot of powerful <a href="https://www.rstudio.com/products/rstudio/features/">features</a> for writing and debugging R code, but while using it on large data, it can be challenging due to:</p>

<ul>
  <li>Scalability</li>
  <li>Privacy and security of data</li>
  <li>Ability to connect R workflows with other tools (Spark, Tensorflow etc.)</li>
  <li>Backing up the R code automatically</li>
</ul>

<p>We solve these challenges by running <a href="#deploying-rstudio-on-k8s">RStudio on Kubernetes</a> and using <a href="#blobfuse-for-remote-data-access">Blobfuse</a> for remote data access.</p>

<h2 id="deploying-rstudio-on-k8s">Deploying RStudio on k8s</h2>

<p>First, we will see how we can deploy RStudio using <a href="https://kubernetes.io">Kubernetes</a>, Deploying RStudio on Kubernetes has many advantages :</p>

<ul>
  <li>Allows exploration tools like RStudio also to be in controlled and secure environments.</li>
  <li>With combinations of blobfuse, makes sure the data never leaves the compliance boundary.</li>
  <li>Also makes RStudio available in web browser from anywhere.</li>
  <li>RStudio, running on cluster can have a lot more resources that can be used by for exploration by R.</li>
  <li>With cache interval, you can automatically cache the remote data for longer time as well, for better performance.</li>
</ul>

<p>We will create a Kubernetes <a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/">deployment</a> for RStudio. The following YAML describes our RStudio deployment. Dont worry if you don’t all the fields in the YAML, you don’t need to understand all the kubernetes concepts for now.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">rstudio</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">rstudio</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">rstudio</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">rstudio</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name </span><span class="pi">:</span> <span class="s">rstudio</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">rocker/rstudio</span> 
        <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Always"</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">8787</span>
          <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
        <span class="na">command</span><span class="pi">:</span>
         <span class="pi">-</span> <span class="s2">"</span><span class="s">/bin/bash"</span>
         <span class="pi">-</span> <span class="s2">"</span><span class="s">-c"</span>
         <span class="pi">-</span> <span class="s2">"</span><span class="s">--"</span>
        <span class="na">args </span><span class="pi">:</span>
         <span class="pi">-</span> <span class="s1">'</span><span class="s">rstudio-server</span><span class="nv"> </span><span class="s">start</span><span class="nv"> </span><span class="s">;</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">infinity'</span>
</code></pre></div></div>

<p>I have put these configuration files on github here <a href="https://github.com/dharmeshkakadia/rstudio-k8s">dharmeshkakadia/rstudio-k8s</a>. You can deploy the above YAML directly from github link with:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create -f https://raw.githubusercontent.com/dharmeshkakadia/rstudio-k8s/master/rstudio.yaml
</code></pre></div></div>

<p>The above deployment doesn’t assign public end point to your RStudio deployment and you can access via local port-forwarding:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl port-forward deploy/rstudio 8787:8787
</code></pre></div></div>

<p>That’s it! Now you are ready to use RStudio. Go to <a href="http://localhost:8787">http://localhost:8787</a> and use username and password as <code class="language-plaintext highlighter-rouge">rstudio</code>.</p>

<p><img src="/images/rstudio-k8s.png" alt="Rstudio" /></p>

<h2 id="blobfuse-for-remote-data-access">Blobfuse for remote data access</h2>

<p><a href="https://github.com/Azure/azure-storage-fuse">Blobfuse</a> allows access to remote blob storage data as if it was part of local file system. This makes it possible to work with many packages that doesn’t yet work with remote storage natively. This also makes it simple for developers to be hidden from operational aspect of how the data is managed. We use <a href="https://github.com/Azure/kubernetes-volume-drivers/tree/master/flexvolume/blobfuse">blobfuse kubernetes volume drivers</a> to integrate blobfuse with Kubernetes. With this setup, we can allows access to data on Azure Blob Storage as as local files from with Kubernetes constructs like pods. You need to install blobfuse on the cluster, by following <a href="https://github.com/Azure/kubernetes-volume-drivers/tree/master/flexvolume/blobfuse">instructions</a>. Note that using blobfuse is not required to use RStudio Kubernetes, but only required for integration with Azure Storage.</p>

<p>You will need to create a <a href="https://kubernetes.io/docs/concepts/configuration/secret/">Kubernetes Secret</a> that allows access to the given storage account. You can use the command similar to the below, replacing your account name and storage key. Note that in production environment, this should not be done manually, but secret management solutions like <a href="https://docs.microsoft.com/en-us/azure/key-vault/">Azure Key Vault</a> with your CI/CD pipelines.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create secret generic blofuse-datasecret --from-literal accountname=storage-account-name --from-literal accountkey="fJg4..0A==" --type="azure/blobfuse"
</code></pre></div></div>

<p>Here is the full YAML with volume mounts sections addded. We are instructing Kubernetes to use the secret we just created (<code class="language-plaintext highlighter-rouge">blobfuse-datasecret</code>) and mount <code class="language-plaintext highlighter-rouge">datacontainer-name</code> from the storage account at location <code class="language-plaintext highlighter-rouge">/data/</code> in the container. Of course you should change the value of <code class="language-plaintext highlighter-rouge">datacontainer-name</code> with the name of the storage container you want to access.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">rstudio</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">rstudio</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">rstudio</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">rstudio</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name </span><span class="pi">:</span> <span class="s">rstudio</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">rocker/rstudio</span> 
        <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Always"</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">8787</span>
          <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
        <span class="na">command</span><span class="pi">:</span>
         <span class="pi">-</span> <span class="s2">"</span><span class="s">/bin/bash"</span>
         <span class="pi">-</span> <span class="s2">"</span><span class="s">-c"</span>
         <span class="pi">-</span> <span class="s2">"</span><span class="s">--"</span>
        <span class="na">args </span><span class="pi">:</span>
         <span class="pi">-</span> <span class="s1">'</span><span class="s">rstudio-server</span><span class="nv"> </span><span class="s">start</span><span class="nv"> </span><span class="s">;</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">infinity'</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">data</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/data</span>
      <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">data</span>
        <span class="na">flexVolume</span><span class="pi">:</span>
          <span class="na">driver</span><span class="pi">:</span> <span class="s2">"</span><span class="s">azure/blobfuse"</span>
          <span class="na">secretRef</span><span class="pi">:</span>
            <span class="na">name</span><span class="pi">:</span> <span class="s">blofuse-datasecret</span>
          <span class="na">options</span><span class="pi">:</span>
            <span class="na">container</span><span class="pi">:</span> <span class="s">datacontainer-name</span>
</code></pre></div></div>

<p>You can deploy the above YAML with:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create -f rstudio-blobfuse.yaml
</code></pre></div></div>

<p>That’s it ! Now when using RStudio, you can read files under <code class="language-plaintext highlighter-rouge">/data</code> as with normal file APIs and use the remote data as if they were local files. We can use the same mechanism to backup R code from a <code class="language-plaintext highlighter-rouge">local</code> folder to Azure Blob. Also, you since you can have multiple volumes mounted, you can easily use conventions like <code class="language-plaintext highlighter-rouge">/userdata</code>, <code class="language-plaintext highlighter-rouge">/researchdata</code> and so on to have <em>all</em> of various datasets available to you during exploration.</p>

<p>There are many more possibilities, by integrating data frameworks and Kubernetes. For example, you can use similar deployment for deploying your <a href="https://shiny.rstudio.com/">Shiny</a> apps on kubernetes, which will auto scale based on your traffic or load. You can use also deploy R ETL scripts as Kubernetes <a href="https://kubernetes.io/docs/concepts/workloads/controllers/jobs-run-to-completion/">Jobs</a> or <a href="https://kubernetes.io/docs/concepts/workloads/controllers/cron-jobs/">CronJobs</a> and get fault tolerance alerts etc for free. We use such Kubernetes constructs across our entire data/AI stack with Spark, Tensorflow, Jupyter etc. and had a lot of success with it.</p>

<p>Have fun data hacking !</p>

    </div>

    

    <div class="post__share">
      <ul class="share__list list-reset">
        

        <li class="share__item">
          <a class="share__link share__twitter" href="https://twitter.com/intent/tweet?text=Versatile%20RStudio%20development%20environment%20on%20Kubernetes&url=/rstudio-k8s/"
            onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter" rel="nofollow">
              <svg enable-background="new 0 0 56.693 56.693" height="56.693" viewBox="0 0 56.693 56.693" width="56.693" xmlns="http://www.w3.org/2000/svg"><path d="m52.837 15.065c-1.811.805-3.76 1.348-5.805 1.591 2.088-1.25 3.689-3.23 4.444-5.592-1.953 1.159-4.115 2-6.418 2.454-1.843-1.964-4.47-3.192-7.377-3.192-5.581 0-10.106 4.525-10.106 10.107 0 .791.089 1.562.262 2.303-8.4-.422-15.848-4.445-20.833-10.56-.87 1.492-1.368 3.228-1.368 5.082 0 3.506 1.784 6.6 4.496 8.412-1.656-.053-3.215-.508-4.578-1.265-.001.042-.001.085-.001.128 0 4.896 3.484 8.98 8.108 9.91-.848.23-1.741.354-2.663.354-.652 0-1.285-.063-1.902-.182 1.287 4.015 5.019 6.938 9.441 7.019-3.459 2.711-7.816 4.327-12.552 4.327-.815 0-1.62-.048-2.411-.142 4.474 2.869 9.786 4.541 15.493 4.541 18.591 0 28.756-15.4 28.756-28.756 0-.438-.009-.875-.028-1.309 1.974-1.422 3.688-3.203 5.042-5.23z"/></svg>
            </a>
        </li>

      </ul>
    </div>

    <div class="post__navigation">
      
      <a class="prev" href="/mxnet-tools-docker/">
        <div class="prev__post-icon">
          <svg enable-background="new 0 0 512 512" height="512" viewBox="0 0 512 512" width="512" xmlns="http://www.w3.org/2000/svg"><path d="m352 128.4-32.3-32.4-159.7 160 159.7 160 32.3-32.4-127.3-127.6z"/></svg>
        </div>
        <span class="post__nav-wrapper">
          <div class="post__nav-image" style="background-image: url()"></div>
          <h2 class="post__nav-title"><time datetime="2018-12-05T00:00:00+00:00">Dec 05, 2018</time> <br>MXNet tools in docker</h2>
        </span>
      </a>
      

      
      <a class="next" href="/github-actions-awesome-bot/">
        <div class="next__post-icon">
          <svg enable-background="new 0 0 512 512" height="512" viewBox="0 0 512 512" width="512" xmlns="http://www.w3.org/2000/svg"><path d="m160 128.4 32.3-32.4 159.7 160-159.7 160-32.3-32.4 127.3-127.6z"/></svg>
        </div>
        <span class="post__nav-wrapper">
          <div class="post__nav-image" style="background-image: url()"></div>
          <h2 class="post__nav-title"><time datetime="2018-12-05T00:00:00+00:00">Dec 05, 2018</time> <br>Verifying links with Github actions & Awesome Bot</h2>
        </span>
      </a>
      
    </div>

    

  </article>
  <!-- end post -->
</div>

  </main>
  <!-- end content -->

  <div class="container">
  <!-- begin footer -->
  <footer class="footer">
    <div class="footer__inner">
      <div class="contact">
        <div class="contact__title">Have a question where I can help? <a href="mailto:dharmesh.kakadia@gmail.com">Email me</a></div>
        <ul class="contact__list list-reset">
          
          <li class="contact__item">
            <a class="contact__link" href="https://twitter.com/dharmeshkakadia">Twitter</a>
          </li>
          
          <li class="contact__item">
            <a class="contact__link" href="https://facebook.com/dharmesh.kakadia">Facebook</a>
          </li>
          
          <li class="contact__item">
            <a class="contact__link" href="https://github.com/dharmeshkakadia">Github</a>
          </li>
          
          <li class="contact__item">
            <a class="contact__link" href="https://instagram.com/dharmeshkakadia">LinkedIn</a>
          </li>
          
        </ul>
      </div>
    </div>
  </footer>
  <!-- end footer -->
</div>


  <!-- begin js -->
  <script src="/assets/js/vendors/jquery-3.3.1.min.js"></script>
  <script src="/assets/js/vendors/aos.js"></script>
  <script src="/assets/js/vendors/jquery.fitvids.js"></script>
  <script src="/assets/js/common.js"></script>
  <!-- end js -->
</body>

</html>
