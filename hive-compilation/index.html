<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">

  <!-- mobile responsive meta -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Compiling hive for a non-release hadoop version</title>
  <meta name='description' content='Curious'>

  <link rel="canonical" href="/hive-compilation/">
  <link rel="alternate" type="application/rss+xml" title="Dharmesh Kakadia" href="/feed.xml">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@site_username">
  <meta name="twitter:creator" content="@creator_username">
  
    <meta name="twitter:title" content="Compiling hive for a non-release hadoop version">
  
  
    <meta name="twitter:url" content="/hive-compilation/">
  
  
    <meta name="twitter:description" content="Curious">
  
  
    <meta name="twitter:image:src" content="/path/to/image/logo.png">
  

  <!-- Main Stylesheet -->
  <link href="/assets/css/main.css" rel="stylesheet">

</head>


<body>

  
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-44808193-2', 'auto');
  ga('send', 'pageview');
</script>
  

  <div class="container-full">
  <!-- begin header -->
  <header class="header">

    <div class="logo">
      <a class="logo__link" href="/">
      
        <img class="logo__image" src=" /images/dharmesh.png" alt="Dharmesh Kakadia">
        Dharmesh Kakadia
      
      </a>
    </div>

    <nav class="main-nav">
      <span class="main-nav__open">
        <div style="width: 30px;height: 4px;background-color: black; margin: 5px 0;"></div>
        <div style="width: 30px;height: 4px;background-color: black; margin: 5px 0;"></div>
        <div style="width: 30px;height: 4px;background-color: black; margin: 5px 0;"></div>
      </span>

      <div class="main-nav__box">
        <span class="main-nav__close">Close</span>

        <ul class="nav__list list-reset">
          <li class="nav__item">
            <a href="/" class="nav__link">Home</a>
          </li>

          <li class="nav__item">
            <a href="/about" class="nav__link">About</a>
          </li>

          <li class="nav__item">
            <a href="/words/" class="nav__link">Quotes</a>
          </li>

          <li class="nav__item">
            <a href="/book/" class="nav__link">My Book</a>
          </li>


          <li class="nav__item">
            <a href="/talks" class="nav__link">Talks</a>
          </li>
          
        </ul>

      </div>

    </nav>

  </header>
  <!-- end header -->
</div>


  <!-- begin content -->
  <main class="content" aria-label="Content">
    <div class="container">
  <!-- begin post -->
  <article class="post">
    <div class="post__head" data-aos="fade-up" data-aos-easing="ease-out-quad" data-aos-duration="700">
      <h1 class="post__title">Compiling hive for a non-release hadoop version</h1>
      <div class="post__date">
        <time datetime="2014-08-15T00:00:00+00:00">Published Aug 15, 2014</time>
      </div>
      
    </div>

    <div class="post__content" data-aos="fade-up" data-aos-easing="ease-out-quad" data-aos-delay="100" data-aos-duration="700">
      <p>We have been working on many interesting things around <a href="https://www.microsoft.com/en-us/research/project/perforator-2/">Perforator</a> like extending the core model to other systems like hive, tez etc. At MSR, we developed on hadoop-yarn trunk and have deployed that with a version name <code class="language-plaintext highlighter-rouge">3.0.0-SNAPSHOT</code>. and for a lot of other reasons, we can’t just rename the version. I have struggled a bit in last few days to run hive on top of the non-release version like ours and this blog highlights my solution.</p>

<p>While hive documentation have step to <a href="https://cwiki.apache.org/confluence/display/Hive/GettingStarted">compile from source</a> I could not find any documentation on how to compile for a version not yet “integrated” with hive. I was hoping to find at least some information on this from <a href="https://cwiki.apache.org/confluence/display/Hive/HiveDeveloperFAQ">developer page</a> of hive. Surprisingly enough, I didn’t get anything there. Looking at the pom.xml, I had an early impression that, just changing the <code class="language-plaintext highlighter-rouge">0.23-hadoop-version</code> in the <code class="language-plaintext highlighter-rouge">pom.xml</code> would do the trick. But it turns out that hive on starting, calls the hadoop version command to decide what shims to load. and thus will fail with unrecognized hadoop version error, like following.</p>

<noscript><pre>400: Invalid request</pre></noscript>
<script src="https://gist.github.com/009b4a268e2a34162742.js"> </script>

<p>There is an important piece of information as highlighted above, <code class="language-plaintext highlighter-rouge">ShimLoads.java</code> is the culprit, as before loading the Shims for a given hadoop version it does a sanity check that the hadoop version number is valid. so just go ahead an make sure that this tests passes. I know this test is important, but if you are in situation like me,  just go ahead and add the following lines in the file.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ vim shims/common/src/main/java/org/apache/hadoop/hive/shims/ShimLoader.java
</code></pre></div></div>

<p>and add the case statement for your version number. I will add “case 3:” as shown below.</p>

<noscript><pre>400: Invalid request</pre></noscript>
<script src="https://gist.github.com/7a3821c07240826920b3.js?file=ShimLoader-Modeified.java"> </script>

<p>Now you can build hive with following command.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ mvn clean install -Phadoop-2,dist
</code></pre></div></div>

<p>After successful completion of the above command, you would find the packages hive distribution in the <code class="language-plaintext highlighter-rouge">packaging/target/</code> folder.</p>

<h3 id="gotchas">Gotchas</h3>

<ol>
  <li>
    <p>Don’t use JDK 7 otherwise you might hive will fail to compile (mentioned in <a href="https://issues.apache.org/jira/browse/HIVE-3197">https://issues.apache.org/jira/browse/HIVE-3197</a> and <a href="https://issues.apache.org/jira/browse/HIVE-3384">https://issues.apache.org/jira/browse/HIVE-3384</a>)</p>
  </li>
  <li>
    <p>Contrib module in current hive trunk is broken by the dependencies on the package <code class="language-plaintext highlighter-rouge">org.apache.hadoop.record</code>, which is     moved to hadoop-streaming project and then reverted (mentioned in <a href="https://issues.apache.org/jira/browse/HIVE-7077">https://issues.apache.org/jira/browse/HIVE-7077</a> and <a href="https://issues.apache.org/jira/browse/HADOOP-10474">https://issues.apache.org/jira/browse/HADOOP-10474</a>)</p>

    <p>If you encounter this, there is a simple workaround for that. You can just build the <code class="language-plaintext highlighter-rouge">contrib</code> module with version of hadoop that is not effected by above change. Instead of doing any changes to the pom file etc, I simply built it with the <code class="language-plaintext highlighter-rouge">hadoop-1</code>. While this is likely to be fixed in the future version,here are the commands to workaround,</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  $ cd contrib
  $ mvn clean install -Phadoop-1,dist
  $ cd ..
  $ mvn install -Phadoop-2,dist
</code></pre></div>    </div>

    <p>Note that we have removed clean from the goals, so as to avoid compiling the contrib module with the <code class="language-plaintext highlighter-rouge">hadoop-2</code>. Since <code class="language-plaintext highlighter-rouge">mvn</code> sees that the module is already compiled, it just goes ahead with the rest of hive.</p>
  </li>
</ol>

    </div>

    

    <div class="post__share">
      <ul class="share__list list-reset">
        <li class="share__item">
          <a class="share__link share__twitter" href="https://twitter.com/intent/tweet?text=Compiling%20hive%20for%20a%20non-release%20hadoop%20version&via=dharmeshkakadia&url=/hive-compilation/"
            onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter" rel="nofollow">
              <svg enable-background="new 0 0 56.693 56.693" height="56.693" viewBox="0 0 56.693 56.693" width="56.693" xmlns="http://www.w3.org/2000/svg"><path d="m52.837 15.065c-1.811.805-3.76 1.348-5.805 1.591 2.088-1.25 3.689-3.23 4.444-5.592-1.953 1.159-4.115 2-6.418 2.454-1.843-1.964-4.47-3.192-7.377-3.192-5.581 0-10.106 4.525-10.106 10.107 0 .791.089 1.562.262 2.303-8.4-.422-15.848-4.445-20.833-10.56-.87 1.492-1.368 3.228-1.368 5.082 0 3.506 1.784 6.6 4.496 8.412-1.656-.053-3.215-.508-4.578-1.265-.001.042-.001.085-.001.128 0 4.896 3.484 8.98 8.108 9.91-.848.23-1.741.354-2.663.354-.652 0-1.285-.063-1.902-.182 1.287 4.015 5.019 6.938 9.441 7.019-3.459 2.711-7.816 4.327-12.552 4.327-.815 0-1.62-.048-2.411-.142 4.474 2.869 9.786 4.541 15.493 4.541 18.591 0 28.756-15.4 28.756-28.756 0-.438-.009-.875-.028-1.309 1.974-1.422 3.688-3.203 5.042-5.23z"/></svg>
            </a>
        </li>

      </ul>
    </div>


    <!-- Begin Mailchimp Signup Form -->
<!-- <link href="//cdn-images.mailchimp.com/embedcode/horizontal-slim-10_7.css" rel="stylesheet" type="text/css"> -->
<style type="text/css">
	#mc_embed_signup{background:#fff; clear:left; font:24px Helvetica,Arial,sans-serif; width:100%;}
	/* Add your own Mailchimp form style overrides in your site stylesheet or in this style block.
	   We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
     #mc_embed_signup form {text-align:center; padding:10px 0 10px 0;}
      .mc-field-group { display: inline-block; } /* positions input field horizontally */
      #mc_embed_signup input.email {font-family:'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 15px; border: 1px solid #ABB0B2;  -webkit-border-radius: 3px; -moz-border-radius: 3px; border-radius: 3px; color: #343434; background-color: #fff; box-sizing:border-box; height:32px; padding: 0px 0.4em; display: inline-block; margin: 0; width:250px; vertical-align:top;}
      #mc_embed_signup label {display:block; font-size:22px; padding-bottom:10px; font-weight:bold;}
      #mc_embed_signup .clear {display: inline-block;} /* positions button horizontally in line with input */
      #mc_embed_signup .button {font-size: 13px; border: none; -webkit-border-radius: 3px; -moz-border-radius: 3px; border-radius: 3px; letter-spacing: .03em; color: #fff; background-color: rgb(14, 13, 13); box-sizing:border-box; height:30px; line-height:32px; padding:0 18px; display: inline-block; margin: 0; transition: all 0.23s ease-in-out 0s;}
      #mc_embed_signup .button:hover {background-color:rgb(59, 58, 58); cursor:pointer;}
      #mc_embed_signup div#mce-responses {float:left; top:-1.4em; padding:0em .5em 0em .5em; overflow:hidden; width:90%;margin: 0 5%; clear: both;}
      #mc_embed_signup div.response {margin:1em 0; padding:1em .5em .5em 0; font-weight:bold; float:left; top:-1.5em; z-index:1; width:80%;}
      #mc_embed_signup #mce-error-response {display:none;}
      #mc_embed_signup #mce-success-response {color:#529214; display:none;}
      #mc_embed_signup label.error {display:block; float:none; width:auto; margin-left:1.05em; text-align:left; padding:.5em 0;}
      @media (max-width: 768px) {
          #mc_embed_signup input.email {width:100%; margin-bottom:5px;}
          #mc_embed_signup .clear {display: block; width: 100% }
          #mc_embed_signup .button {width: 100%; margin:0; }
      }
</style>
<div id="mc_embed_signup">
<form action="https://world.us12.list-manage.com/subscribe/post?u=726520195d8ffab18dde3b5d8&amp;id=f2a783d3df" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
	<label for="mce-EMAIL">Subscribe to get my latest post</label>
	<input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="your email address" required>
    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
    <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_726520195d8ffab18dde3b5d8_f2a783d3df" tabindex="-1" value=""></div>
    <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
    </div>
</form>
</div>


<!--End mc_embed_signup-->

    <div class="post__navigation">
      
      <a class="prev" href="/msr-summerschool/">
        <div class="prev__post-icon">
          <svg enable-background="new 0 0 512 512" height="512" viewBox="0 0 512 512" width="512" xmlns="http://www.w3.org/2000/svg"><path d="m352 128.4-32.3-32.4-159.7 160 159.7 160 32.3-32.4-127.3-127.6z"/></svg>
        </div>
        <span class="post__nav-wrapper">
          <div class="post__nav-image" style="background-image: url()"></div>
          <h2 class="post__nav-title"><time datetime="2014-08-15T00:00:00+00:00">Aug 15, 2014</time> <br>A great experience at Microsoft Summer School 2012</h2>
        </span>
      </a>
      

      
      <a class="next" href="/Hello-World/">
        <div class="next__post-icon">
          <svg enable-background="new 0 0 512 512" height="512" viewBox="0 0 512 512" width="512" xmlns="http://www.w3.org/2000/svg"><path d="m160 128.4 32.3-32.4 159.7 160-159.7 160-32.3-32.4 127.3-127.6z"/></svg>
        </div>
        <span class="post__nav-wrapper">
          <div class="post__nav-image" style="background-image: url()"></div>
          <h2 class="post__nav-title"><time datetime="2014-08-15T00:00:00+00:00">Aug 15, 2014</time> <br>Hello World</h2>
        </span>
      </a>
      
    </div>

    

  </article>
  <!-- end post -->
</div>

  </main>
  <!-- end content -->

  <div class="container">
  <!-- begin footer -->
  <footer class="footer">
    <div class="footer__inner">
      <div class="contact">
        <div class="contact__title">Have a question where I can help? <a href="mailto:dharmesh.kakadia@gmail.com">Email me</a></div>
        <ul class="contact__list list-reset">
          
          <li class="contact__item">
            <a class="contact__link" rel="me" href="https://twitter.com/dharmeshkakadia">Twitter</a>
          </li>
          
          <li class="contact__item">
            <a class="contact__link" rel="me" href="https://facebook.com/dharmesh.kakadia">Facebook</a>
          </li>
          
          <li class="contact__item">
            <a class="contact__link" rel="me" href="https://github.com/dharmeshkakadia">Github</a>
          </li>
          
          <li class="contact__item">
            <a class="contact__link" rel="me" href="https://instagram.com/dharmeshkakadia">LinkedIn</a>
          </li>
          
        </ul>
      </div>
    </div>
  </footer>
  <!-- end footer -->
</div>


  <!-- begin js -->
  <script src="/assets/js/vendors/jquery-3.3.1.min.js"></script>
  <script src="/assets/js/vendors/aos.js"></script>
  <script src="/assets/js/vendors/jquery.fitvids.js"></script>
  <script src="/assets/js/common.js"></script>
  <!-- end js -->
</body>

</html>
