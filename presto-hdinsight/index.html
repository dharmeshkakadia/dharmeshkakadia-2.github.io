<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">

  <!-- mobile responsive meta -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Presto on HDInsight</title>
  <meta name='description' content='Curious'>

  <link rel="canonical" href="/presto-hdinsight/">
  <link rel="alternate" type="application/rss+xml" title="Dharmesh Kakadia" href="/feed.xml">

  <!-- Main Stylesheet -->
  <link href="/assets/css/main.css" rel="stylesheet">

</head>


<body>

  
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-44808193-2', 'auto');
  ga('send', 'pageview');
</script>
  

  <div class="container-full">
  <!-- begin header -->
  <header class="header">

    <div class="logo">
      <a class="logo__link" href="/">
      
        <img class="logo__image" src=" /images/dharmesh.png" alt="Dharmesh Kakadia">
        Dharmesh Kakadia
      
      </a>
    </div>

    <nav class="main-nav">
      <span class="main-nav__open">menu</span>

      <div class="main-nav__box">
        <span class="main-nav__close">Close</span>

        <ul class="nav__list list-reset">
          <li class="nav__item">
            <a href="/" class="nav__link">Home</a>
          </li>

          <li class="nav__item">
            <a href="/about" class="nav__link">About</a>
          </li>

          <li class="nav__item">
            <a href="/words/" class="nav__link">Quotes</a>
          </li>

          <li class="nav__item">
            <a href="/book/" class="nav__link">My Book</a>
          </li>


          <li class="nav__item">
            <a href="/talks" class="nav__link">Talks</a>
          </li>
          
        </ul>

      </div>

    </nav>

  </header>
  <!-- end header -->
</div>


  <!-- begin content -->
  <main class="content" aria-label="Content">
    <div class="container">
  <!-- begin post -->
  <article class="post">
    <div class="post__head" data-aos="fade-up" data-aos-easing="ease-out-quad" data-aos-duration="700">
      <h1 class="post__title">Presto on HDInsight</h1>
      <div class="post__date">
        <time datetime="2017-04-02T00:00:00+00:00">Published Apr 02, 2017</time>
      </div>
      
    </div>

    <div class="post__content" data-aos="fade-up" data-aos-easing="ease-out-quad" data-aos-delay="100" data-aos-duration="700">
      <p>This article will explain presto internals and how to install presto on <a href="https://azure.microsoft.com/en-us/services/hdinsight/">Azure HDInsight</a>. If you are familiar with presto, you can jump in directly to the <a href="#installing-presto-on-hdinsight">installation</a>.</p>

<h1 id="what-is-presto">What is Presto?</h1>
<p><a href="https://prestodb.io/">Presto</a> is a <strong>fast</strong> distributed SQL query engine for big data. Presto is suitable for interactive querying of petabytes of data.</p>

<h1 id="presto-architecture">Presto Architecture</h1>
<p>To understand how presto works, lets look at the presto architecture. The following figure from the presto documentation highlights key <a href="https://github.com/prestodb/presto/blob/master/presto-docs/src/main/sphinx/overview/concepts.rst">components</a> of presto.</p>

<p><img src="/images/presto-arch.png" alt="presto-arch.png" /></p>

<h2 id="clients">Clients</h2>
<p>Clients are where you submit queries to Presto. Clients can use JDBC/ODBC/REST protocol to talk to coordinator.</p>

<h2 id="coordinator">Coordinator</h2>
<p>Presto coordinator is responsible for managing workernode membership, parsing the queries, generating execution plan and managing execution of the query. During the execution of the queries, it also manages the delivery of the data between tasks.</p>

<p>The coordinator translates the given query into logical plan. The logical plan is composed of series of stages and each stage is then executed in a distributed fashion using several tasks across workers. This is very similar to other distributed query execution engines like Hive and Spark.</p>

<h2 id="workers">Workers</h2>
<p>Presto worker is responsible for executing tasks and processing data. This is where the real work of processing the data happens.</p>

<h2 id="communication">Communication</h2>
<p>Each presto worker advertises itself to the coordinator through <a href="https://github.com/airlift/discovery">discovery server</a>. All the communication in presto between Coordinator, workers and clients happen via REST API.</p>

<h2 id="connectors">Connectors</h2>
<p>Presto has a federated query model where each data sources is a presto connector. One way to think about different presto connectors is similar to how different drivers enable a database to talk to multiple sources. Some of the currently available connectors on the presto project:</p>

<ul>
  <li><a href="https://prestodb.io/docs/current/connector/kafka.html">Kafka</a>,</li>
  <li><a href="https://prestodb.io/docs/current/connector/cassandra.html">Cassandra</a>,</li>
  <li><a href="https://prestodb.io/docs/current/connector/hive.html">Hive</a>,</li>
  <li><a href="https://prestodb.io/docs/current/connector/accumulo.html">Accumulo</a>,</li>
  <li><a href="https://prestodb.io/docs/current/connector/mongodb.html">MongoDB</a>,</li>
  <li><a href="https://prestodb.io/docs/current/connector/mysql.html">MySQL</a>,</li>
  <li><a href="https://prestodb.io/docs/current/connector/postgresql.html">PostegreSQL</a>,</li>
  <li><a href="https://prestodb.io/docs/current/connector/redis.html">Redis</a></li>
  <li>… <a href="https://prestodb.io/docs/current/connector.html">more</a>.</li>
</ul>

<h2 id="catalog">Catalog</h2>
<p>Each catalog in presto is associated with a specific connector, specified in the catalog configuration with <code class="highlighter-rouge">connector.name</code>. Based on this name Presto (Catalog Manager) decides how to query a particular data source. When writing a query in Presto, you can use the fully-qualified name that contains <code class="highlighter-rouge">connector.schemaname.tablename</code>. For example, if you have a hive table <code class="highlighter-rouge">revenue</code> in database name <code class="highlighter-rouge">prod</code>, you can refer it as <code class="highlighter-rouge">hive.prod.revenue</code>. The below figure highlights how multiple catalogs fit in presto:</p>

<p><img src="/images/presto-internals.png" alt="presto-internals.png" /></p>

<p>As showed in the figure, each connector implements two APIs</p>
<ol>
  <li>Data streaming API : Specifies how to read/write the data.</li>
  <li>Metadata API : Specifies what is the schema or how to interpret the data.</li>
</ol>

<p>For further information about presto, <a href="https://prestodb.io/docs/current">presto documentation</a> and <a href="https://groups.google.com/forum/#!forum/presto-users">presto user group</a> are great places to look :)</p>

<h1 id="presto-use-cases">Presto Use Cases</h1>

<p>An obvious use case for Presto is for traditional data analysis similar to SQL-on-Hadoop and Spark-SQL. Like other engines, Presto support both SQL and UDFs. Presto supports wide range of <a href="https://prestodb.io/docs/current/functions.html">inbuilt and user defined functions</a>. The SQL syntax is similar to Hive and Spark SQL syntax and should make you feel home. Presto even has a <a href="https://prestodb.io/docs/current/migration/from-hive.html">migration guide from Hive</a>. :) Presto JDBC/ODBC drivers allow you to connect to wide range of tools like <a href="https://prestodb.io/docs/current/installation/tableau.html">Tableu</a> easily. Presto is also well suited for powering analytics dashboards and has <a href="https://prestodb.io/resources.html">client libraries</a> in your favorite language, if you prefer to talk programmatically. And while we are at it, the auto-complete in presto CLI is pretty dope! Oh and did I mention how cool (and detailed) the presto UI is ?</p>

<p><img src="/images/prestoui.png" alt="prestoui.png" /></p>

<p>Presto is very successfully used by number of organizations for their fast data analysis needs and in using large scale SQL analytics. One of the prime aspect of Presto that caught my attention, however, was the ability to <strong>query various data sources in a single query</strong>. This is so magical ✨, let me give you an example to illustrate it,</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span><span class="err"> </span><span class="n">s</span><span class="p">.</span><span class="n">region</span><span class="p">,</span><span class="err"> </span>
<span class="err">       </span><span class="n">revenue</span><span class="err"> </span>
<span class="k">FROM</span><span class="err">   </span><span class="n">hive</span><span class="p">.</span><span class="n">weblog</span><span class="p">.</span><span class="n">clickstreams</span><span class="err"> </span><span class="n">s</span><span class="err"> </span>
<span class="err">       </span><span class="k">JOIN</span><span class="err"> </span><span class="n">mysql</span><span class="p">.</span><span class="n">prod</span><span class="p">.</span><span class="n">transections</span><span class="err"> </span><span class="n">t</span><span class="err"> </span>
<span class="err">         </span><span class="k">ON</span><span class="err"> </span><span class="n">s</span><span class="p">.</span><span class="n">userid</span><span class="err"> </span><span class="o">=</span><span class="err"> </span><span class="n">t</span><span class="p">.</span><span class="n">userid</span><span class="err"> </span>
<span class="k">GROUP</span><span class="err">  </span><span class="k">BY</span><span class="err"> </span><span class="n">s</span><span class="p">.</span><span class="n">region</span><span class="err"> </span>
<span class="k">ORDER</span><span class="err">  </span><span class="k">BY</span><span class="err"> </span><span class="n">revenue</span><span class="err"> </span><span class="k">DESC</span><span class="err"> </span>
<span class="k">LIMIT</span><span class="err">  </span><span class="mi">100</span>
</code></pre></div></div>

<p>The above query joins data in Hive WASB with data in a MySQL database. This obviates the need to bring and manage all the data under a single system . This allows best tool for the job, while still retaining ability to query them. In the example above, the transaction data resided in the SQL database while clickstream logs are in Hive/WASB and the above query joins them to find out top 100 regions by revenue.</p>

<p>This solves a big pain point of big data, where right now you have to copy them in to single location and manage it under a single system. The big data, IMO, should be about deriving insights from data and not managing ETL pipelines and dealing with deduplication issues. Each system has different tradeoffs and are fit to and serve only part of the larger picture in the big data architectures. This, in my opinion, is so important since, the world where each system wants to be the <em>only</em> system to store and process data, presto acknowledges the need to be a good citizen in the big data architecture.</p>

<h1 id="who-is-using-presto">Who is using Presto?</h1>
<p>Presto started out at Facebook and has become key piece in the data infrastructure of many organizations. Some of the prominent names who use presto are:</p>
<ul>
  <li>Netflix</li>
  <li>Airbnb</li>
  <li>Dropbox</li>
  <li>LinkedIn</li>
  <li>Uber</li>
  <li>NASDAQ</li>
  <li>Walmart</li>
  <li>Alibaba</li>
  <li>… <a href="https://github.com/prestodb/presto/wiki/Presto-Users">many more</a> and YOU by following the next secion :)</li>
</ul>

<h1 id="installing-presto-on-hdinsight">Installing Presto on HDInsight</h1>

<p>Now that we know how Presto works, lets get our hand dirty. HDInsight <a href="https://docs.microsoft.com/en-us/azure/hdinsight/hdinsight-hadoop-customize-cluster-linux">Custom action scripts</a> allows extending HDInsight in arbitrary ways through a bash script. <a href="https://github.com/dharmeshkakadia/presto-hdinsight">Presto custom action script</a> can be used on new and existing 3.5+ HDInsight hadoop clusters to install and run presto. Creating a presto cluster is very simple : run script action with following URL on headnodes and workernodes.</p>

<p><code class="highlighter-rouge">
https://raw.githubusercontent.com/dharmeshkakadia/presto-hdinsight/master/installpresto.sh
</code></p>

<p>The below GIF shows the steps while creating a cluster and specifying the presto script.</p>

<p><img src="/images/presto-install-steps.gif" alt="presto-install-steps.gif" /></p>

<p>Now you can SSH to the cluster and start using presto.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>presto --schema default
</code></pre></div></div>

<p>This will drop you into presto-cli and you can start analyzing data right away.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>presto&gt; select count(*) from hivesampletable;
</code></pre></div></div>

<p>By Default, <a href="https://prestodb.io/docs/current/connector/hive.html">Hive</a> and <a href="https://prestodb.io/docs/current/connector/tpch.html">TPCH</a> connectors are configured. Hive connector is configured to use the default installed Hive installation, so all the tables from Hive will be automatically visible in presto. You can also play around with TPCH or <a href="https://github.com/dharmeshkakadia/presto-hdinsight#how-do-i-run-tpcds-on-presto">TPCDS</a> datasets.</p>

<h1 id="inner-working-of-installation-script">Inner working of installation script</h1>

<p>If you are interested in details of what is the above script action is doing, let me break it down. We use <a href="https://github.com/prestodb/presto-yarn">Apache Slider</a> to manage presto resources through YARN. In a N node standalone cluster with the script will create 1 presto co-ordinator, N-2 presto worker containers with maximum memory, 1 slider AM that monitors containers and relaunches them on failures.</p>

<p>Customer action invokes <a href="https://github.com/dharmeshkakadia/presto-hdinsight/blob/master/installpresto.sh">installpresto.sh</a>, which performs following steps:</p>

<ol>
  <li>Download the github repo.</li>
  <li>Create a <a href="https://github.com/dharmeshkakadia/presto-hdinsight/blob/master/createsliderbuild.sh">presto build</a> that has support of Windows Azure Storage Blob (WASB). Note that this step is required since the WASB support has not <a href="https://github.com/prestodb/presto-hadoop-apache2/pull/14">merged</a> in the upstream Presto yet. The script builds the package under <code class="highlighter-rouge">/var/lib/presto/</code> on the primary headnode.</li>
  <li>Install the created slider package.</li>
  <li>Create appropriate presto-slider configuration files (<code class="highlighter-rouge">/var/lib/presto/presto-hdinsight-master/appConfig-default.json</code> and <code class="highlighter-rouge">/var/lib/presto/presto-hdinsight-master/resources-default.json</code>) for the presto slider package. All the configs are generated by <a href="https://github.com/dharmeshkakadia/presto-hdinsight/blob/master/createconfigs.sh">createconfigs.sh</a> script.</li>
  <li>Start the presto with slider.</li>
  <li>Wait for the presto to come up and install <a href="https://prestodb.io/docs/current/installation/cli.html">preso-cli</a> in the <code class="highlighter-rouge">/usr/local/bin/</code>.</li>
</ol>

<p>You can <a href="https://github.com/dharmeshkakadia/presto-hdinsight#how-do-i-customize-presto-installation">customize the presto installation</a> to suit your needs.</p>

<h1 id="airpal">Airpal</h1>
<p><a href="http://airbnb.io/airpal/">Airpal</a> is the web query interface for presto. The following GIF from the airpal website gives a good overview of available features in airpal.</p>

<p><img src="/images/airpla-demo.gif" alt="airpla-demo.gif" /></p>

<h2 id="installing-airpal-on-headnode">Installing Airpal on headnode</h2>
<p>You can install Airpal on the cluster headnode using following the steps.</p>

<ol>
  <li>Install presto as shown in the previous section.</li>
  <li>Now, SSH to the headnode and run the following command to know address of the presto coordinator</li>
</ol>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  sudo slider registry  --name presto1 --getexp presto
</code></pre></div></div>

<p>You will see output like following, note the IP:Port.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  {
    "coordinator_address" : [ {
      "value" : "10.0.0.11:9090",
      "level" : "application",
      "updatedTime" : "Sat Feb 25 05:45:14 UTC 2017"
  }
</code></pre></div></div>

<ol>
  <li>Run the <a href="https://github.com/dharmeshkakadia/presto-hdinsight/blob/master/installairpal.sh">install airpal</a> script as sudo as follows with the address noted from the previous step.</li>
</ol>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  cd /var/lib/presto/
  sudo ./presto-hdinsight-master/installpresto.sh 10.0.0.11:9090
</code></pre></div></div>

<p>This script installs airpal with all its dependencies. Once the script is complete, airpal will be running on port 9191. Note that, to use airpal from your browser, you have to setup local tunneling and SOCKS proxy on your browser. Or you can install airpal on edgenode.</p>

<h2 id="installing-airpal-on-edgenode">Installing Airpal on Edgenode</h2>
<p>HDInsight Edgenodes are acceisble to/from outside world and you can install any software on them. You can deploy <a href="https://github.com/dharmeshkakadia/presto-hdinsight/blob/master/airpal-deploy.json">Airpal on HDInsight</a> Edge node using as follows:</p>

<ol>
  <li>Install presto using the above steps.</li>
  <li>Now, SSH to the headnode and run the following command to figure out address of the presto coordinator</li>
</ol>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  sudo slider registry  --name presto1 --getexp presto
</code></pre></div></div>

<p>You will see output like following, note the IP:Port.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  {
    "coordinator_address" : [ {
      "value" : "10.0.0.11:9090",
      "level" : "application",
      "updatedTime" : "Sat Feb 25 05:45:14 UTC 2017"
  }
</code></pre></div></div>

<ol>
  <li>
    <p>Click <a href="https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fdharmeshkakadia%2Fpresto-hdinsight%2Fmaster%2Fairpal-deploy.json">here</a> to create an edgenode and deploy airpal.</p>
  </li>
  <li>Provide Clustername, EdgeNodeSize and PrestoAddress (noted above).</li>
  <li>To access airpal UI, go to your cluster on azure portal and navigate to Applications and click on portal. You have to login with cluster login credentials.</li>
</ol>

<h1 id="conclusion">Conclusion</h1>

<p>Now, that you have Presto and Airpal running on HDInsight, go do your data analysis. If you find any issues, feel free to <a href="https://github.com/dharmeshkakadia/presto-hdinsight/issues/new">report</a> them. Note that, like all other custom action scripts, this is not a Microsoft Supported product.</p>

<p><a href="https://twitter.com/dharmeshkakadia">I Would love to hear your questions or feedback</a>.</p>

    </div>

    

    <div class="post__share">
      <ul class="share__list list-reset">
        

        <li class="share__item">
          <a class="share__link share__twitter" href="https://twitter.com/intent/tweet?text=Presto%20on%20HDInsight&url=/presto-hdinsight/"
            onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter" rel="nofollow">
              <svg enable-background="new 0 0 56.693 56.693" height="56.693" viewBox="0 0 56.693 56.693" width="56.693" xmlns="http://www.w3.org/2000/svg"><path d="m52.837 15.065c-1.811.805-3.76 1.348-5.805 1.591 2.088-1.25 3.689-3.23 4.444-5.592-1.953 1.159-4.115 2-6.418 2.454-1.843-1.964-4.47-3.192-7.377-3.192-5.581 0-10.106 4.525-10.106 10.107 0 .791.089 1.562.262 2.303-8.4-.422-15.848-4.445-20.833-10.56-.87 1.492-1.368 3.228-1.368 5.082 0 3.506 1.784 6.6 4.496 8.412-1.656-.053-3.215-.508-4.578-1.265-.001.042-.001.085-.001.128 0 4.896 3.484 8.98 8.108 9.91-.848.23-1.741.354-2.663.354-.652 0-1.285-.063-1.902-.182 1.287 4.015 5.019 6.938 9.441 7.019-3.459 2.711-7.816 4.327-12.552 4.327-.815 0-1.62-.048-2.411-.142 4.474 2.869 9.786 4.541 15.493 4.541 18.591 0 28.756-15.4 28.756-28.756 0-.438-.009-.875-.028-1.309 1.974-1.422 3.688-3.203 5.042-5.23z"/></svg>
            </a>
        </li>

      </ul>
    </div>

    <div class="post__navigation">
      
      <a class="prev" href="/sapiens-review/">
        <div class="prev__post-icon">
          <svg enable-background="new 0 0 512 512" height="512" viewBox="0 0 512 512" width="512" xmlns="http://www.w3.org/2000/svg"><path d="m352 128.4-32.3-32.4-159.7 160 159.7 160 32.3-32.4-127.3-127.6z"/></svg>
        </div>
        <span class="post__nav-wrapper">
          <div class="post__nav-image" style="background-image: url()"></div>
          <h2 class="post__nav-title"><time datetime="2017-04-02T00:00:00+00:00">Apr 02, 2017</time> <br>Book review - Sapiens</h2>
        </span>
      </a>
      

      
      <a class="next" href="/go-dep-example/">
        <div class="next__post-icon">
          <svg enable-background="new 0 0 512 512" height="512" viewBox="0 0 512 512" width="512" xmlns="http://www.w3.org/2000/svg"><path d="m160 128.4 32.3-32.4 159.7 160-159.7 160-32.3-32.4 127.3-127.6z"/></svg>
        </div>
        <span class="post__nav-wrapper">
          <div class="post__nav-image" style="background-image: url()"></div>
          <h2 class="post__nav-title"><time datetime="2017-04-02T00:00:00+00:00">Apr 02, 2017</time> <br>Go Dep Example</h2>
        </span>
      </a>
      
    </div>

    

  </article>
  <!-- end post -->
</div>

  </main>
  <!-- end content -->

  <div class="container">
  <!-- begin footer -->
  <footer class="footer">
    <div class="footer__inner">
      <div class="contact">
        <div class="contact__title">Have a question where I can help? <a href="mailto:dharmesh.kakadia@gmail.com">Email me</a></div>
        <ul class="contact__list list-reset">
          
          <li class="contact__item">
            <a class="contact__link" href="https://twitter.com/dharmeshkakadia">Twitter</a>
          </li>
          
          <li class="contact__item">
            <a class="contact__link" href="https://facebook.com/dharmesh.kakadia">Facebook</a>
          </li>
          
          <li class="contact__item">
            <a class="contact__link" href="https://github.com/dharmeshkakadia">Github</a>
          </li>
          
          <li class="contact__item">
            <a class="contact__link" href="https://instagram.com/dharmeshkakadia">LinkedIn</a>
          </li>
          
        </ul>
      </div>
    </div>
  </footer>
  <!-- end footer -->
</div>


  <!-- begin js -->
  <script src="/assets/js/vendors/jquery-3.3.1.min.js"></script>
  <script src="/assets/js/vendors/aos.js"></script>
  <script src="/assets/js/vendors/jquery.fitvids.js"></script>
  <script src="/assets/js/common.js"></script>
  <!-- end js -->
</body>

</html>
